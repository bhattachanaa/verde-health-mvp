<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verde Health - AI Healthcare Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-green: #27ae60;
            --secondary-green: #2ecc71;
            --light-green: #a8e6cf;
            --dark-green: #1e7e3e;
            --bg-gradient: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            --green-gradient: linear-gradient(135deg, #27ae60, #2ecc71);
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --shadow-hover: 0 15px 40px rgba(0,0,0,0.15);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated background elements */
        .bg-decoration {
            position: fixed;
            border-radius: 50%;
            background: rgba(46, 204, 113, 0.1);
            animation: float 20s infinite ease-in-out;
            pointer-events: none;
            z-index: 0;
        }

        .bg-decoration:nth-child(1) {
            width: 300px;
            height: 300px;
            top: -150px;
            left: -150px;
            animation-delay: 0s;
        }

        .bg-decoration:nth-child(2) {
            width: 200px;
            height: 200px;
            bottom: -100px;
            right: -100px;
            animation-delay: 5s;
        }

        .bg-decoration:nth-child(3) {
            width: 150px;
            height: 150px;
            top: 50%;
            left: 80%;
            animation-delay: 10s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            33% { transform: translateY(-30px) rotate(120deg); }
            66% { transform: translateY(30px) rotate(240deg); }
        }

        /* Header with Logo */
        .header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-img {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark-green);
            letter-spacing: -0.5px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 10px;
        }

        .nav-tab {
            padding: 10px 24px;
            background: transparent;
            border: 2px solid var(--primary-green);
            color: var(--primary-green);
            border-radius: 25px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .nav-tab.active {
            background: var(--primary-green);
            color: white;
        }

        .nav-tab:hover {
            background: var(--primary-green);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        /* Main Container */
        .main-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
            position: relative;
            z-index: 1;
        }

        /* Card Styles */
        .card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            animation: slideIn 0.5s ease;
            position: relative;
            z-index: 1;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* View Sections */
        .view-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .view-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-green);
            background: white;
            box-shadow: 0 0 0 4px rgba(39, 174, 96, 0.1);
        }

        /* Editable input styles */
        .editable-input {
            border: 1px solid transparent;
            background: transparent;
            padding: 5px 8px;
            border-radius: 4px;
            width: 100%;
            transition: all 0.2s ease;
        }

        .editable-input:focus,
        .editable-input.editing {
            border-color: var(--primary-green);
            background: white;
            outline: none;
        }

        /* Buttons */
        .btn {
            padding: 14px 28px;
            background: var(--green-gradient);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(39, 174, 96, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-edit {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .btn-save {
            background: var(--green-gradient);
        }

        .btn-cancel {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }

        /* Patient Table */
        .patient-table {
            width: 100%;
            background: white;
            border-radius: 15px;
            overflow: visible;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }

        .patient-table thead {
            background: var(--green-gradient);
            color: white;
        }

        .patient-table th {
            padding: 20px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .patient-table tbody tr {
            transition: all 0.3s ease;
            border-bottom: 1px solid #f0f0f0;
            position: relative;
        }

        .patient-table tbody tr:hover {
            background: #f8f8f8;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .patient-table td {
            padding: 18px 15px;
            font-size: 15px;
        }

        /* Status Dropdown */
        .status-select {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .status-select:focus {
            outline: none;
            border-color: var(--primary-green);
        }

        .status-incomplete {
            background: #fff3cd;
            color: #856404;
        }

        .status-complete {
            background: #d4edda;
            color: #155724;
        }

        /* Call Status Display */
        .call-status {
            display: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
            animation: slideIn 0.5s ease;
        }

        .call-status.active {
            display: block;
        }

        .call-status h3 {
            margin-bottom: 10px;
            font-size: 20px;
        }

        .call-status p {
            opacity: 0.9;
            font-size: 16px;
        }

        /* Loading Animation */
        .loading-dots {
            display: inline-flex;
            gap: 5px;
        }

        .loading-dots span {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark-green);
        }

        .modal-close {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 20px;
        }

        .modal-close:hover {
            background: #e0e0e0;
            transform: rotate(90deg);
        }

        /* PDF Viewer */
        .pdf-viewer {
            width: 100%;
            height: 600px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .pdf-viewer iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Messages */
        .message {
            padding: 15px 20px;
            border-radius: 12px;
            margin-top: 20px;
            animation: slideIn 0.5s ease;
            display: none;
        }

        .message.active {
            display: block;
        }

        .message.success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 1px solid #b1dfbb;
        }

        .message.error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 1px solid #f1b0b7;
        }

        .message.info {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            color: #0c5460;
            border: 1px solid #abdde5;
        }

        /* Welcome Text */
        .welcome-title {
            font-size: 32px;
            color: var(--dark-green);
            margin-bottom: 10px;
        }

        .welcome-subtitle {
            color: #666;
            font-size: 18px;
            margin-bottom: 30px;
        }

        /* Loading Spinner */
        .spinner {
            display: none;
            width: 40px;
            height: 40px;
            border: 4px solid #f0f0f0;
            border-top: 4px solid var(--primary-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        .spinner.active {
            display: block;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Dashboard header buttons */
        .dashboard-actions {
            display: flex;
            gap: 10px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 20px;
            }

            .logo-img {
                width: 40px;
                height: 40px;
            }

            .card {
                padding: 20px;
            }

            .patient-table {
                font-size: 14px;
                overflow-x: auto;
                display: block;
            }

            .patient-table th,
            .patient-table td {
                padding: 12px 8px;
                font-size: 12px;
            }

            .modal-content {
                padding: 20px;
                width: 95%;
            }

            .pdf-viewer {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <!-- Background Decorations -->
    <div class="bg-decoration"></div>
    <div class="bg-decoration"></div>
    <div class="bg-decoration"></div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <img src="logo.png" alt="Verde Health Logo" class="logo-img" />
                <div class="logo-text">Verde Health</div>
            </div>
            <div class="nav-tabs">
                <button class="nav-tab active" id="patientTab" onclick="showView('patient')">
                    Patient Portal
                </button>
                <button class="nav-tab" id="doctorTab" onclick="showView('doctor')">
                    Doctor Portal
                </button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Patient View -->
        <div id="patientView" class="view-section active">
            <div class="card">
                <h1 class="welcome-title">Welcome to Verde Health</h1>
                <p class="welcome-subtitle">Your AI-powered healthcare assistant is ready to help</p>
                
                <div class="form-group">
                    <label class="form-label">Enter Your Phone Number</label>
                    <input type="tel" id="phoneInput" class="form-input" placeholder="(555) 123-4567" />
                    <small style="color: #666; font-size: 14px; margin-top: 5px; display: block;">
                        We'll call you immediately to conduct your health assessment
                    </small>
                </div>
                
                <button class="btn" id="activateCallBtn" onclick="activateCall()">
                    Activate AI Call
                </button>
                
                <div class="call-status" id="callStatus">
                    <h3>Initiating Call</h3>
                    <p>Our AI assistant is calling you now. Please answer your phone.</p>
                    <div class="loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
                
                <div class="message success" id="callSuccess">
                    Call completed successfully! Your healthcare provider will review your assessment shortly.
                </div>
                
                <div class="message error" id="callError">
                    <span id="errorMessage">Unable to initiate call. Please try again.</span>
                </div>
                
                <div class="message info" id="callInfo">
                    <span id="infoMessage">Your call is being processed...</span>
                </div>
            </div>
        </div>

        <!-- Doctor Login View -->
        <div id="doctorLoginView" class="view-section">
            <div class="card">
                <h1 class="welcome-title">Doctor Portal</h1>
                <p class="welcome-subtitle">Access your patient records and SOAP notes</p>
                
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="docUsername" class="form-input" placeholder="Enter username" value="doctor" />
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="docPassword" class="form-input" placeholder="Enter password" value="password" />
                </div>
                
                <button class="btn" onclick="doctorLogin()">
                    Sign In
                </button>
                
                <p style="margin-top: 20px; color: #888; font-size: 14px;">
                    Demo credentials: doctor / password
                </p>
            </div>
        </div>

        <!-- Doctor Dashboard View -->
        <div id="doctorDashboard" class="view-section">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <div>
                        <h1 class="welcome-title">Welcome, Dr. Aaron</h1>
                        <p class="welcome-subtitle">Patient Management Dashboard</p>
                    </div>
                    <div class="dashboard-actions">
                        <button class="btn btn-save" onclick="addNewPatient()">
                            Add Patient
                        </button>
                        <button class="btn" onclick="refreshPatients()">
                            Refresh
                        </button>
                        <button class="btn" onclick="logout()">
                            Logout
                        </button>
                    </div>
                </div>
                
                <div class="spinner" id="loadingSpinner"></div>
                
                <table class="patient-table" id="patientTable">
                    <thead>
                        <tr>
                            <th>Patient Name</th>
                            <th>Phone</th>
                            <th>Age</th>
                            <th>Call Status</th>
                            <th>Call Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="patientTableBody">
                        <!-- Patient rows will be dynamically added here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Patient Modal -->
    <div class="modal" id="addPatientModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Patient</h2>
                <button class="modal-close" onclick="closeAddPatientModal()">×</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Patient Name</label>
                <input type="text" id="newPatientName" class="form-input" placeholder="Enter patient name" />
            </div>
            
            <div class="form-group">
                <label class="form-label">Phone Number</label>
                <input type="tel" id="newPatientPhone" class="form-input" placeholder="(555) 123-4567" />
            </div>
            
            <div class="form-group">
                <label class="form-label">Age</label>
                <input type="number" id="newPatientAge" class="form-input" placeholder="Enter age" min="0" max="150" />
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-cancel" onclick="closeAddPatientModal()">Cancel</button>
                <button class="btn btn-save" onclick="saveNewPatient()">Save Patient</button>
            </div>
        </div>
    </div>

    <!-- SOAP PDF Viewer Modal -->
    <div class="modal" id="pdfModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">SOAP Notes - <span id="patientNameInModal">Patient</span></h2>
                <button class="modal-close" onclick="closePdfModal()">×</button>
            </div>
            
            <div class="pdf-viewer">
                <iframe id="pdfFrame" src=""></iframe>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn" onclick="downloadCurrentPdf()">
                    Download PDF
                </button>
                <button class="btn btn-cancel" onclick="closePdfModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentPatients = [];
        let currentPatientId = null;
        let currentPdfUrl = null;
        let refreshInterval = null;
        let editingRow = null;

        // View Management
        function showView(view) {
            document.querySelectorAll('.view-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            if (view === 'patient') {
                document.getElementById('patientView').classList.add('active');
                document.getElementById('patientTab').classList.add('active');
                clearInterval(refreshInterval);
            } else if (view === 'doctor') {
                document.getElementById('doctorLoginView').classList.add('active');
                document.getElementById('doctorTab').classList.add('active');
                clearInterval(refreshInterval);
            }
        }

        // Patient Side - Activate Vapi Call
        async function activateCall() {
            const phoneInput = document.getElementById('phoneInput');
            const phone = phoneInput.value.replace(/\D/g, '');
            
            if (phone.length < 10) {
                showMessage('error', 'Please enter a valid 10-digit phone number');
                return;
            }
            
            const formattedPhone = formatPhoneNumber(phone);
            
            document.getElementById('activateCallBtn').disabled = true;
            document.getElementById('callStatus').classList.add('active');
            hideAllMessages();
            
            try {
                const response = await fetch('/api/vapi/initiate-call', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phoneNumber: '+1' + phone
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    document.querySelector('#callStatus h3').textContent = 'Call Initiated';
                    document.querySelector('#callStatus p').textContent = `Calling ${formattedPhone}... Please answer your phone.`;
                    
                    pollCallStatus(data.callId);
                    
                } else {
                    throw new Error(data.error || 'Failed to initiate call');
                }
                
            } catch (error) {
                console.error('Error activating call:', error);
                document.getElementById('callStatus').classList.remove('active');
                showMessage('error', error.message || 'Unable to initiate call. Please try again.');
                document.getElementById('activateCallBtn').disabled = false;
            }
        }

        // Poll for call status
        async function pollCallStatus(callId) {
            let attempts = 0;
            const maxAttempts = 60;
            
            const pollInterval = setInterval(async () => {
                attempts++;
                
                try {
                    const response = await fetch(`/api/vapi/call-status/${callId}`);
                    const data = await response.json();
                    
                    if (data.status === 'completed') {
                        clearInterval(pollInterval);
                        document.getElementById('callStatus').classList.remove('active');
                        showMessage('success', 'Call completed successfully! Your healthcare provider will review your assessment shortly.');
                        document.getElementById('activateCallBtn').disabled = false;
                        document.getElementById('phoneInput').value = '';
                    } else if (data.status === 'failed' || data.status === 'no-answer') {
                        clearInterval(pollInterval);
                        document.getElementById('callStatus').classList.remove('active');
                        showMessage('error', 'Call could not be completed. Please try again.');
                        document.getElementById('activateCallBtn').disabled = false;
                    } else if (attempts >= maxAttempts) {
                        clearInterval(pollInterval);
                        document.getElementById('callStatus').classList.remove('active');
                        showMessage('info', 'Call is taking longer than expected. We\'ll process it in the background.');
                        document.getElementById('activateCallBtn').disabled = false;
                    }
                } catch (error) {
                    console.error('Error polling status:', error);
                }
            }, 5000);
        }

        // Doctor Login
        function doctorLogin() {
            const username = document.getElementById('docUsername').value;
            const password = document.getElementById('docPassword').value;
            
            if (username && password) {
                document.getElementById('doctorLoginView').classList.remove('active');
                document.getElementById('doctorDashboard').classList.add('active');
                loadPatients();
                
                refreshInterval = setInterval(loadPatients, 30000);
            } else {
                alert('Please enter username and password');
            }
        }

        // Logout
        function logout() {
            clearInterval(refreshInterval);
            document.getElementById('doctorDashboard').classList.remove('active');
            document.getElementById('doctorLoginView').classList.add('active');
        }

        // Load Patients
        async function loadPatients() {
            const spinner = document.getElementById('loadingSpinner');
            const tableBody = document.getElementById('patientTableBody');
            
            if (tableBody.children.length === 0) {
                spinner.classList.add('active');
            }
            
            try {
                const response = await fetch('/api/sessions');
                const data = await response.json();
                
                currentPatients = data;
                
                if (data && data.length > 0) {
                    tableBody.innerHTML = data.map((patient, index) => {
                        const statusComplete = patient.status === 'completed' && patient.soapnotes;
                        const statusText = statusComplete ? 'Call Complete' : 'Call Not Complete';
                        const statusClass = statusComplete ? 'status-complete' : 'status-incomplete';
                        
                        const callDate = patient.createdat ? 
                            new Date(patient.createdat).toLocaleString('en-US', {
                                month: 'short',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            }) : 'N/A';
                        
                        let actions = '';
                        if (patient.soapnotes && patient.soapnotes.pdf_url) {
                            actions = `<button class="btn btn-small" onclick="viewSoapPdf('${patient.id}')">View SOAP</button>`;
                        } else if (patient.status === 'calling') {
                            actions = '<span style="color: #007bff;">In Progress...</span>';
                        } else {
                            actions = '<span style="color: #999;">Not Available</span>';
                        }
                        
                        return `
                            <tr data-patient-id="${patient.id}" data-index="${index}">
                                <td>
                                    <input type="text" class="editable-input" value="${patient.patient_name || 'Unknown'}" 
                                           data-field="patient_name" readonly />
                                </td>
                                <td>
                                    <input type="text" class="editable-input" value="${formatPhoneNumber(patient.phonenumber) || 'N/A'}" 
                                           data-field="phonenumber" readonly />
                                </td>
                                <td>
                                    <input type="number" class="editable-input" value="${patient.patient_age || ''}" 
                                           data-field="patient_age" readonly min="0" max="150" />
                                </td>
                                <td>
                                    <select class="status-select ${statusClass}" data-field="status" 
                                            onchange="updateStatus('${patient.id}', this.value)">
                                        <option value="incomplete" ${!statusComplete ? 'selected' : ''}>Call Not Complete</option>
                                        <option value="complete" ${statusComplete ? 'selected' : ''}>Call Complete</option>
                                    </select>
                                </td>
                                <td>${callDate}</td>
                                <td>
                                    <div style="display: flex; gap: 5px;">
                                        ${actions}
                                        <button class="btn btn-small btn-edit" onclick="editPatient('${patient.id}')">Edit</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #999;">No patients found. Calls will appear here once initiated.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading patients:', error);
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #f00;">Error loading patients. Please refresh.</td></tr>';
            } finally {
                spinner.classList.remove('active');
            }
        }

        // Edit Patient
        function editPatient(patientId) {
            const row = document.querySelector(`tr[data-patient-id="${patientId}"]`);
            const editBtn = row.querySelector('.btn-edit');
            
            if (editingRow && editingRow !== row) {
                cancelEdit();
            }
            
            if (editBtn.textContent === 'Edit') {
                editingRow = row;
                row.querySelectorAll('.editable-input').forEach(input => {
                    input.removeAttribute('readonly');
                    input.classList.add('editing');
                });
                editBtn.textContent = 'Save';
                editBtn.classList.remove('btn-edit');
                editBtn.classList.add('btn-save');
            } else {
                savePatientEdits(patientId);
            }
        }

        // Save Patient Edits
        async function savePatientEdits(patientId) {
            const row = document.querySelector(`tr[data-patient-id="${patientId}"]`);
            const updates = {};
            
            row.querySelectorAll('.editable-input').forEach(input => {
                const field = input.dataset.field;
                let value = input.value;
                
                if (field === 'phonenumber') {
                    value = value.replace(/\D/g, '');
                } else if (field === 'patient_age') {
                    value = parseInt(value) || null;
                }
                
                updates[field] = value;
            });
            
            try {
                const response = await fetch(`/api/sessions/${patientId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updates)
                });
                
                if (response.ok) {
                    row.querySelectorAll('.editable-input').forEach(input => {
                        input.setAttribute('readonly', 'readonly');
                        input.classList.remove('editing');
                    });
                    
                    const editBtn = row.querySelector('.btn-save');
                    editBtn.textContent = 'Edit';
                    editBtn.classList.remove('btn-save');
                    editBtn.classList.add('btn-edit');
                    
                    editingRow = null;
                    showMessage('success', 'Patient information updated successfully');
                    setTimeout(() => hideAllMessages(), 3000);
                }
            } catch (error) {
                console.error('Error saving patient edits:', error);
                showMessage('error', 'Failed to save changes');
            }
        }

        // Cancel Edit
        function cancelEdit() {
            if (editingRow) {
                const patientId = editingRow.dataset.patientId;
                const patientIndex = parseInt(editingRow.dataset.index);
                const patient = currentPatients[patientIndex];
                
                editingRow.querySelectorAll('.editable-input').forEach(input => {
                    const field = input.dataset.field;
                    if (field === 'phonenumber') {
                        input.value = formatPhoneNumber(patient[field]) || 'N/A';
                    } else {
                        input.value = patient[field] || '';
                    }
                    input.setAttribute('readonly', 'readonly');
                    input.classList.remove('editing');
                });
                
                const editBtn = editingRow.querySelector('.btn-save');
                if (editBtn) {
                    editBtn.textContent = 'Edit';
                    editBtn.classList.remove('btn-save');
                    editBtn.classList.add('btn-edit');
                }
                
                editingRow = null;
            }
        }

        // Update Status
        async function updateStatus(patientId, value) {
            const status = value === 'complete' ? 'completed' : 'incomplete';
            
            try {
                const response = await fetch(`/api/sessions/${patientId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: status })
                });
                
                if (response.ok) {
                    const select = document.querySelector(`tr[data-patient-id="${patientId}"] .status-select`);
                    select.className = `status-select ${value === 'complete' ? 'status-complete' : 'status-incomplete'}`;
                }
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        // Add New Patient
        function addNewPatient() {
            document.getElementById('addPatientModal').classList.add('active');
        }

        // Close Add Patient Modal
        function closeAddPatientModal() {
            document.getElementById('addPatientModal').classList.remove('active');
            document.getElementById('newPatientName').value = '';
            document.getElementById('newPatientPhone').value = '';
            document.getElementById('newPatientAge').value = '';
        }

        // Save New Patient
        async function saveNewPatient() {
            const name = document.getElementById('newPatientName').value;
            const phone = document.getElementById('newPatientPhone').value.replace(/\D/g, '');
            const age = document.getElementById('newPatientAge').value;
            
            if (!name || !phone) {
                alert('Please enter patient name and phone number');
                return;
            }
            
            try {
                const response = await fetch('/api/sessions/manual', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        patient_name: name,
                        phonenumber: phone,
                        patient_age: age ? parseInt(age) : null,
                        status: 'incomplete'
                    })
                });
                
                if (response.ok) {
                    closeAddPatientModal();
                    loadPatients();
                    showMessage('success', 'Patient added successfully');
                    setTimeout(() => hideAllMessages(), 3000);
                }
            } catch (error) {
                console.error('Error adding patient:', error);
                showMessage('error', 'Failed to add patient');
            }
        }

        // View SOAP PDF
        async function viewSoapPdf(patientId) {
            const patient = currentPatients.find(p => p.id === patientId);
            if (!patient || !patient.soapnotes || !patient.soapnotes.pdf_url) {
                alert('SOAP notes not available for this patient');
                return;
            }
            
            currentPatientId = patientId;
            currentPdfUrl = patient.soapnotes.pdf_url;
            
            document.getElementById('patientNameInModal').textContent = patient.patient_name || 'Unknown Patient';
            
            try {
                const response = await fetch(`/api/soap/pdf/${patient.soapnotes.id}`);
                const data = await response.json();
                
                if (data.url) {
                    document.getElementById('pdfFrame').src = data.url;
                    document.getElementById('pdfModal').classList.add('active');
                } else {
                    throw new Error('PDF URL not available');
                }
            } catch (error) {
                console.error('Error loading PDF:', error);
                alert('Unable to load SOAP notes. Please try again.');
            }
        }

        // Close PDF Modal
        function closePdfModal() {
            document.getElementById('pdfModal').classList.remove('active');
            document.getElementById('pdfFrame').src = '';
        }

        // Download Current PDF
        async function downloadCurrentPdf() {
            if (currentPdfUrl) {
                const patient = currentPatients.find(p => p.id === currentPatientId);
                const fileName = `SOAP_${patient?.patient_name?.replace(/\s/g, '_') || 'Patient'}_${new Date().toISOString().split('T')[0]}.pdf`;
                
                const a = document.createElement('a');
                a.href = currentPdfUrl;
                a.download = fileName;
                a.target = '_blank';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        }

        // Refresh patients
        function refreshPatients() {
            loadPatients();
        }

        // Utility Functions
        function formatPhoneNumber(phone) {
            const cleaned = (phone || '').toString().replace(/\D/g, '');
            if (cleaned.length === 10) {
                return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3, 6)}-${cleaned.slice(6)}`;
            }
            return phone || '';
        }

        function showMessage(type, message) {
            hideAllMessages();
            
            if (type === 'error') {
                document.getElementById('errorMessage').textContent = message;
                document.getElementById('callError').classList.add('active');
            } else if (type === 'success') {
                document.getElementById('callSuccess').classList.add('active');
            } else if (type === 'info') {
                document.getElementById('infoMessage').textContent = message;
                document.getElementById('callInfo').classList.add('active');
            }
            
            setTimeout(hideAllMessages, 10000);
        }

        function hideAllMessages() {
            document.getElementById('callSuccess').classList.remove('active');
            document.getElementById('callError').classList.remove('active');
            document.getElementById('callInfo').classList.remove('active');
        }

        // Format phone input
        document.getElementById('phoneInput').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 0) {
                if (value.length <= 3) {
                    value = `(${value}`;
                } else if (value.length <= 6) {
                    value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
                } else {
                    value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6, 10)}`;
                }
            }
            e.target.value = value;
        });

        // Format new patient phone input
        document.getElementById('newPatientPhone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 0) {
                if (value.length <= 3) {
                    value = `(${value}`;
                } else if (value.length <= 6) {
                    value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
                } else {
                    value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6, 10)}`;
                }
            }
            e.target.value = value;
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            showView('patient');
        });

        // Handle Enter key for login
        document.getElementById('docPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                doctorLogin();
            }
        });
    </script>
</body>
</html>